<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Admin Dashboard - Finanzas App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <link th:href="@{/css/style.css}" rel="stylesheet" />
</head>
<body>
    <!-- Navbar -->
    <div th:replace="~{layout :: navbar}"></div>

    <div class="container mt-4">
        <!-- Mensajes flash -->
        <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle"></i> 
            <span th:utext="${success}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-triangle"></i> 
            <span th:text="${error}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="fas fa-tachometer-alt"></i> Panel de Administración</h1>
            <a th:href="@{/dashboard}" class="btn btn-outline-primary">
                <i class="fas fa-arrow-left"></i> Volver al Dashboard
            </a>
        </div>

        <!-- Estadísticas Simples -->
        <div class="row g-3 mb-5">
            <div class="col-md-6">
                <div class="card bg-primary text-white">
                    <div class="card-body text-center">
                        <i class="fas fa-users fa-2x mb-2"></i>
                        <h2 th:text="${totalUsuarios}">0</h2>
                        <p class="mb-0">Total Usuarios Registrados</p>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card bg-info text-white">
                    <div class="card-body text-center">
                        <i class="fas fa-chart-bar fa-2x mb-2"></i>
                        <h2 th:text="${totalUsuarios - 1}">0</h2>
                        <p class="mb-0">Usuarios Normales</p>
                        <small>(Excluyendo administradores)</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Lista de Usuarios -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-users"></i> Gestión de Usuarios</h5>
                <span class="badge bg-primary" th:text="${totalUsuarios} + ' usuarios'">0 usuarios</span>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>Nombre</th>
                                <th>Email</th>
                                <th>Rol</th>
                                <th>Fecha Registro</th>
                                <th class="text-end">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="usuario : ${usuarios}">
                                <td th:text="${usuario.id}">1</td>
                                <td th:text="${usuario.nombre}">Usuario</td>
                                <td th:text="${usuario.email}">usuario@email.com</td>
                                <td>
                                    <span th:if="${usuario.rol.name() == 'ADMIN'}" class="badge bg-danger">
                                        <i class="fas fa-crown"></i> ADMIN
                                    </span>
                                    <span th:if="${usuario.rol.name() == 'USUARIO'}" class="badge bg-secondary">
                                        <i class="fas fa-user"></i> USUARIO
                                    </span>
                                </td>
                                <td>
                                    <small class="text-muted" 
                                           th:text="${usuario.fechaRegistro != null ? #temporals.format(usuario.fechaRegistro,'dd/MM/yyyy') : ''}">
                                    </small>
                                </td>
                                <td class="text-end">
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn btn-outline-warning" 
                                                th:attr="data-usuario-id=${usuario.id}, data-usuario-email=${usuario.email}, data-usuario-rol=${usuario.rol.name()}"
                                                onclick="mostrarModalResetPassword(this)" 
                                                title="Resetear Contraseña">
                                            <i class="fas fa-key"></i> Resetear
                                        </button>
                                        <button type="button" class="btn btn-outline-danger" 
                                                th:if="${usuario.rol.name() != 'ADMIN'}"
                                                th:attr="data-usuario-id=${usuario.id}, data-usuario-email=${usuario.email}"
                                                onclick="mostrarModalEliminarUsuario(this)" 
                                                title="Eliminar Usuario">
                                            <i class="fas fa-trash"></i> Eliminar
                                        </button>
                                        <span th:if="${usuario.rol.name() == 'ADMIN'}" class="text-muted small ms-2">
                                            <i class="fas fa-shield-alt"></i> Protegido
                                        </span>
                                    </div>
                                </td>
                            </tr>
                            
                            <tr th:if="${usuarios == null or usuarios.isEmpty()}">
                                <td colspan="6" class="text-center text-muted py-4">
                                    <i class="fas fa-users fa-2x mb-2"></i><br>
                                    No hay usuarios registrados.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Información del Sistema -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card border-info">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0"><i class="fas fa-info-circle"></i> Información del Sistema</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Funciones Disponibles:</h6>
                                <ul class="mb-0">
                                    <li>Ver lista completa de usuarios</li>
                                    <li>Resetear contraseñas de usuarios</li>
                                    <li>Eliminar usuarios normales</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>Seguridad:</h6>
                                <ul class="mb-0">
                                    <li>Los administradores no pueden ser eliminados</li>
                                    <li>Contraseñas reseteadas a: <code>123456</code></li>
                                    <li>Acceso restringido solo a usuarios ADMIN</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Resetear Contraseña -->
    <div class="modal fade" id="resetPasswordModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-key"></i> Resetear Contraseña</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>¿Estás seguro de que deseas resetear la contraseña de <strong id="usuarioEmailReset"></strong>?</p>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Nueva contraseña:</strong> <code>123456</code><br>
                        <small>El usuario deberá cambiar esta contraseña después de iniciar sesión.</small>
                    </div>
                    <div id="adminWarning" class="alert alert-info d-none">
                        <i class="fas fa-shield-alt"></i>
                        <strong>Usuario Administrador:</strong> Ten cuidado al resetear contraseñas de otros administradores.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <form id="resetPasswordForm" method="post">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <button type="submit" class="btn btn-warning">
                            <i class="fas fa-key"></i> Resetear Contraseña
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Eliminar Usuario -->
    <div class="modal fade" id="eliminarUsuarioModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-danger"><i class="fas fa-exclamation-triangle"></i> Eliminar Usuario</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i> <strong>¡Acción Irreversible!</strong>
                    </div>
                    <p>¿Estás seguro de que deseas eliminar permanentemente al usuario <strong id="usuarioEmailEliminar"></strong>?</p>
                    <p class="text-muted">
                        <strong>Consecuencias:</strong><br>
                        • Todas las actividades del usuario serán eliminadas<br>
                        • El usuario perderá acceso al sistema<br>
                        • Esta acción no se puede deshacer
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <form id="eliminarUsuarioForm" method="post">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <button type="submit" class="btn btn-danger">
                            <i class="fas fa-trash"></i> Eliminar Permanentemente
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div th:replace="~{layout :: footer}"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Función para mostrar modal de resetear contraseña
        function mostrarModalResetPassword(button) {
            console.log('mostrarModalResetPassword llamado'); // Debug
            const usuarioId = button.getAttribute('data-usuario-id');
            const usuarioEmail = button.getAttribute('data-usuario-email');
            const usuarioRol = button.getAttribute('data-usuario-rol');
            
            console.log('Datos:', { usuarioId, usuarioEmail, usuarioRol }); // Debug
            
            document.getElementById('usuarioEmailReset').textContent = usuarioEmail;
            document.getElementById('resetPasswordForm').action = '/admin/usuario/' + usuarioId + '/reset-password';
            
            // Mostrar advertencia si es admin
            const adminWarning = document.getElementById('adminWarning');
            if (usuarioRol === 'ADMIN') {
                adminWarning.classList.remove('d-none');
            } else {
                adminWarning.classList.add('d-none');
            }
            
            const modal = new bootstrap.Modal(document.getElementById('resetPasswordModal'));
            modal.show();
        }

        // Función para mostrar modal de eliminar usuario
        function mostrarModalEliminarUsuario(button) {
            console.log('mostrarModalEliminarUsuario llamado'); // Debug
            const usuarioId = button.getAttribute('data-usuario-id');
            const usuarioEmail = button.getAttribute('data-usuario-email');
            
            console.log('Datos:', { usuarioId, usuarioEmail }); // Debug
            
            document.getElementById('usuarioEmailEliminar').textContent = usuarioEmail;
            document.getElementById('eliminarUsuarioForm').action = '/admin/usuario/' + usuarioId + '/eliminar';
            
            const modal = new bootstrap.Modal(document.getElementById('eliminarUsuarioModal'));
            modal.show();
        }

        // Confirmación adicional para resetear contraseña de admin
        document.addEventListener('DOMContentLoaded', function() {
            const resetForm = document.getElementById('resetPasswordForm');
            if (resetForm) {
                resetForm.addEventListener('submit', function(e) {
                    const usuarioEmail = document.getElementById('usuarioEmailReset').textContent;
                    const adminWarning = document.getElementById('adminWarning');
                    
                    if (!adminWarning.classList.contains('d-none')) {
                        if (!confirm('¿Estás ABSOLUTAMENTE seguro de resetear la contraseña del administrador ' + usuarioEmail + '?')) {
                            e.preventDefault();
                            return false;
                        }
                    }
                    
                    // Mostrar mensaje de procesamiento
                    const submitBtn = this.querySelector('button[type="submit"]');
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';
                    submitBtn.disabled = true;
                });
            }
        });
    </script>
</body>
</html>